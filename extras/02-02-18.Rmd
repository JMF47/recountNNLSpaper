---
title: "02-02-18"
author: "Jack Fu"
date: "2/02/2018"
fontsize: 8pt
lassoption: "aspectratio=169"
output: beamer_presentation 
---

```{r setup, include=FALSE}
rm(list=ls())
library(nnls)
# load("~/downloads/bootstrap_sample.rda")
data(matrix_75)
P = matrix_75[[1]]
Pmat = apply(P, 2, as.numeric)

### Normal distribution of errors on top of Y=Xbeta
simulateY2 = function(beta, P){
      # res = sapply(1:length(beta), function(i) (P[,i]*beta[i]/5)^2)
	# reads = sapply(1:length(beta), function(i) rnorm(dim(P)[1], P[,i]*beta[i], sd=sqrt(P[,i]*beta[i])))
	# reads = sapply(1:length(beta), function(i) rnorm(dim(P)[1], P[,i]*beta[i], sd=0.1*(beta[i]>0)))
	# reads = sapply(1:length(beta), function(i) rnorm(dim(P)[1], P[,i]*beta[i], sd=P[,i]*beta[i]*10))
      # reads = sapply(1:length(beta), function(i) rnorm(dim(P)[1], P[,i]*beta[i], sd=0.1))
	reads = sapply(1:length(beta), function(i) rnorm(dim(P)[1], P[,i]*beta[i], sd=0.1))
	Y = apply(reads, 1, sum)
	return(Y)
}
sampleSD = function(values, boot=1000){
	set.seed(values[1])
	return(sd(sample(values, boot, replace=T)))
}
.lnnls = function(counts, P){
      P_binary = P>0
      P_bin_sum = apply(P_binary, 1, sum)
      P_weight = 1/P_bin_sum
      counts = counts*P_weight
      P = P*P_weight
            # penalty = matrix(rep(apply(P, 2, mean)/20, dim(P)[1]), ncol = dim(P)[2], byrow=T)
            # P = P+penalty
      mat = matrix(apply(P, 2, as.numeric), nrow=dim(P)[1])
      mod=nnls::nnls(mat, counts)
      return(mod)
}
pw = function(P){
      P_binary = P>0
      P_bin_sum = apply(P_binary, 1, sum)
      P_weight = 1/P_bin_sum
      P = P*P_weight
      return(P)
}
r2 = function(P){
      r2 = sapply(1:dim(P)[2], function(i) summary(lm(Pmat[,i]~Pmat[,-i]-1))$'r.squared')
      return(r2)
}

simulateBoot = function(samp_size, iter, seed=137){
      set.seed(seed)
      # beta = round(gtools::rdirichlet(1, alpha=rep(1/dim(P)[2], dim(P)[2])) *rnbinom(1, 4, 0.01))
      # beta = rep(100, dim(P)[2])
      # beta = c(100, 20, 50, 100, 150)
      beta = c(100, 100, 0, 100, 0)
      results = NULL
      results_cr = NULL
      r2s = r2(Pmat)
      n = dim(P)[1]
      p = dim(P)[2]
      fstat = qf(0.9, p, n-p)
      threshold = p*fstat
      
      for(i in 1:iter){
      	Ys = matrix(ncol=samp_size, nrow=dim(P)[1])
      	for(j in 1:samp_size){
      		set.seed(i+j)
      		Ys[,j] = simulateY2(beta, P)
      	}
      	models = apply(Ys, 2, .lnnls, P)
      	bs = sapply(models, function(x) x$x)
      	
      	covMat = cov(t(bs))
      
      	## calculate betas
      	## resample each row of beta to calculate sd
      	## use sd to calculate CI
      	sds = apply(bs, 1, sampleSD)#*1/sqrt(1-r2s)
      	intl = bs - sds*1
      	intu = bs + sds*1
      	hitsl = matrix(rep(beta, samp_size), ncol=samp_size) >= intl
      	hitsu = matrix(rep(beta, samp_size), ncol=samp_size) <= intu
      	
      	results = cbind(results, apply((hitsl*hitsu)[,1,drop=F], 1, mean))
      	
      	results = apply((hitsl*hitsu), 1, mean)
      	stats = sapply(1:samp_size, function(i) rbind(bs[,i]-beta) %*% solve(covMat) %*% cbind(bs[,i]-beta))<threshold
            k= which(beta==0)
            stats_dropped = sapply(1:samp_size, function(i) 
                  rbind(bs[-k,i]-beta[-k]) %*% solve(cov(t(bs[-k,]))) %*% cbind(bs[-k,i]-beta[-k]))<(qf(0.9, p-length(k), n-p)*(p-length(k)))

            # Pw = apply(pw(P), 2, as.numeric)
            # results_cr = c(results_cr, rbind(bs[,1]-beta) %*% t(Pw) %*% Pw %*% cbind(bs[,1]-beta)<= threshold*sum(res[,1]^2)/(n-p))
      }
      test = rbind(apply(bs[c(1, 2, 4),], 2, sum), apply(bs[c(3, 5),], 2, sum))
      
      
      bstar = nnls(Pmat, Ys[,1])$x
      bhat = coef(lm(Ys[,1]~Pmat-1))
      ssRes = sum((nnls(Pw, Ys[,1])$residuals)^2)
      invXTX = solve(t(Pw) %*% Pw)
      M2 = diag(bstar/bhat)
      sqrt(ssRes/(n-p)* diag(M2%*%invXTX%*%t(M2)))
}
```

***

* 100 simulated data sets
* Each dataset is 10 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(10, 100)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 20 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(20, 100)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 50 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(50, 100)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 10 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(10, 100, seed = 16)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 20 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(20, 100, seed = 16)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 50 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(50, 100, seed=16)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 10 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(10, 100, seed = 1)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 20 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(20, 100, seed = 1)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 50 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(50, 100, seed=1)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 10 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(10, 100, seed = 123)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 20 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(20, 100, seed = 123)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 50 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(50, 100, seed=123)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```


***

* 100 simulated data sets
* Each dataset is 10 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(10, 100, seed = 1234)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 20 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(20, 100, seed = 1234)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```

***

* 100 simulated data sets
* Each dataset is 50 samples
* Bootstrap betas to estimate sigma
* Use sigma to construst CI
* Look for coverage of intervals of TX1-23

```{r, echo=F}
### Simulate a dataset of size samp_size, with eacn sample sharing the common beta
results_list = simulateBoot(50, 100, seed=1234)
results = results_list[[1]]
results_analytic = results_list[[2]]
par(mfrow=c(2,1))
boxplot(t(results), xlab="Transcript #", ylab="Coverage", main = round(mean(results), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
boxplot(t(results_analytic), xlab="Transcript #", ylab="Coverage", main = round(mean(results_analytic), 3), col=(results_list[[3]]>0)*2, ylim=c(0.5, 1))
abline(h=0.9, col=2)
```


